version: '3'


services:
    cadvisor:
      image: google/cadvisor:latest
      container_name: cadvisor
#      ports:
#        - 8080:8080
      volumes:
        - /:/rootfs:ro
        - /var/run:/var/run:rw
        - /sys:/sys:ro
        - /var/lib/docker/:/var/lib/docker:ro
      depends_on:
        - redis
      expose:
        - "7070"

    nginx_monitor:
      container_name: nginx_monitor
      image: nginx/nginx-prometheus-exporter
      environment:
#            PLUS:
            SCRAPE_URI: http://nginx:9090/stub_status/
            TELEMETRY_PATH: /prometheus/
            NGINX_RETRIES: 5
      expose:
        - "9113"

    grafana:
      container_name: grafana
      image: grafana/grafana:6.5.2
      expose:
        - "3060"
        - "3000"
      links:
        - prometheus
      ports:
        - 3061:3000        
    prometheus:
      container_name: prometheus
      image: prom/prometheus:v2.14.0
      volumes:
         - ./docker/prometheus/:/etc/prometheus/
      command:
         - '--config.file=/etc/prometheus/prometheus.yml'
      expose:
        - "9090"
      ports:
        - 9091:9090

    host_monitor:
      container_name: host_monitor
      image: prom/node-exporter
      expose:
        - "2995"
      volumes:
        - /proc:/host/proc
        - /sys:/host/sys
        - /:/rootfs"
#      network_mode: host
#      environment:
#        PROCFS: /host/proc
#        SYSFS: /host/proc
      command:
#         - '-collector.filesystem.ignored-mount-points "^/(sys|proc|dev|host|etc)($|/)'
        - '--path.procfs=/host/proc'
        - '--path.sysfs=/host/sys'
        - --collector.filesystem.ignored-mount-points
        - "^/(sys|proc|dev|host|etc|rootfs/var/lib/docker/containers|rootfs/var/lib/docker/overlay2|rootfs/run/docker/netns|rootfs/var/lib/docker/aufs|rootfs/var/lib/docker/devicemapper)($$|/)"


    redis:
      restart: always
      container_name: redis
      image: redis:latest
      expose:
        - "6379"

